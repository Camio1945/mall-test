***

# 非原创说明

代码来自 [https://github.com/macrozheng/mall](https://github.com/macrozheng/mall) ，之前忘了 fork 了，想起来的时候发现代码已经对不上了，就采用了复制粘贴老代码的方式。

***

# 警告

仅用于短期测试，不会长期维护，代码（指的是本人新添加的那部分，而不是指原仓库）健壮性非常差，请不要用于生产环境。

请不要用于生产环境！！！

请不要用于生产环境！！！

请不要用于生产环境！！！

***

# 仓库说明

针对 mall 电商提交订单的四个接口的性能测试与优化：

登录：/sso/login

购物车列表：/cart/list

生成确认订单：/order/generateConfirmOrder

生成订单：/order/generateOrder

***

# tag 说明

## v1

性能：每秒 33.4 单。

原始代码，没有做任何优化。

## v2

性能：每秒 68.1 单。

做了如下优化：

1. 登录时，把原先安全性较高但是性能较差的加密方式改为了安全性较低但是性能较高的加密方式。
2. 获取购物车列表时增加缓存。
3. 生成确认订单时增加缓存。
4. 生成订单时，其中『删除购物车』这一步操作放到线程中异步执行。
5. 压测之前，先把相关的数据加载到缓存中。

## v3

性能：每秒 78.9 单。

做了如下优化：

1. 把促销信息放入缓存中，见 PmsPortalProductCacheService.java 。

## v4

性能：每秒 78.0 单。（跟上一版相比区别不大）

做了如下调整：

1. 把 MySQL 的 InnoDB 缓冲区大小（innodb_buffer_pool_size）从 128M 调整到 1G。

注：这一版没有修改代码，只是调整了 MySQL 的配置。

## v5

性能：

| 线程数 | 爬坡时间（rampup） | 每秒单数  |
|-----|--------------|-------|
| 48  | 5 秒          | 83.0  |
| 48  | 0 秒          | 101.7 |
| 64  | 0 秒          | 97.3  |
| 96  | 0 秒          | 96.3  |

做了如下优化：

1. 在订单表（oms_order）中提前生成订单，后续下单时，对于订单表，不再执行 insert 操作，而是执行 update 操作。（订单商品表（oms_order_item）还是用的 insert）


## v6

性能：

| 线程数 | 爬坡时间（rampup） | 每秒单数  |
|-----|--------------|-------|
| 48  | 0 秒          | 108.9 |

做了如下优化：

1. 在订单商品表（oms_order_item）中提前生成订单商品，后续下单时，对于订单商品表，不再执行 insert 操作，而是执行 update 操作。

注：由于我测试的时候只用了一件商品，只涉及到 oms_order_item 表中的一条记录，因此 update 比 insert 的性能要好一点。如果是多条记录的话，需要重新测试，因为 insert 可以合并，但 update 不行。

# 总结

以下是行之有效的优化手段：

1. 增加缓存层，并且要把热点数据预加载到缓存中。
2. 密码登录方式从 BCryptPasswordEncoder 改为 SCryptPasswordEncoder。（注意：会降低安全性）
3. 预生成订单，后续下单时，对于订单表，不再执行 insert 操作，而是执行 update 操作。预生成的订单也应该放进缓存中。
